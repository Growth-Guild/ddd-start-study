# Chapter 11. CQRS

## 단일 모델의 단점
* 조회 화면 특성상 조회 속도가 빠를수록 좋은데 여러 애그리거트의 데이터가 필요하면 구현 방법을 고민해야 한다.
* 여러 애그리거트에서 데이터를 가져와서 출력하는 기능은 고려해야 하는 부분이 많아서 구현을 복잡하게 한다.
* 이러한 복잡도를 낮추기 위한 방법으로 상태 변경을 위한 모데로가 조회를 위한 모델을 분리하는 것이다.

## CQRS
* 시스템이 제공하는 기능은 크게 두 가지로 나눌 수 있다.
  * 하나는 상태를 변경하는 기능이다.
  * 다른 하나는 사용자의 입장에서 데이터를 조회하는 기능이다.
* 도메인 모델 관점에서 상태 변경은 한 애그리거트의 상태를 변경한다.
* 조회 기능은 필요한 데이터를 표시하려면 두 개 이상의 애그리거트가 필요할 때가 많다.
* 상태를 변경하는 범위와 상태를 조회하는 범위가 정확하게 일치하지 않기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 복잡해진다.
* 이러한 문제를 해결하기 위한 방법이 CQRS(Command Query Responsibility Segregation)이다.
  * 명령을 위한 모델과 조회를 위한 모델을 분리하는 패턴이다.
* CQRS를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있다.
  * 명령 모델과 조회 모델을 서로 다른 데이터 저장소에 저장하여 사용할 수도 있다.
  * 두 데이터 저장소 간 데이터 동기화는 이벤트를 활용하여 처리할 수 있다.
  * 명령 모델에서 상태가 변하면 이에 해당하는 이벤트를 발행하고, 조회 모델에서는 이벤트를 전달받아서 변경 내역을 반영한다.
* 명령 모델과 데이터 모델의 저장소를 분리하면 다음과 같은 문제를 고려해야 한다.
  * 명령 모델이 상태가 변하여 이벤트를 발행하고, 조회 모델에서 이벤트를 받아서 이를 반영하기까지의 동기화 시간이 걸릴 수 있다.
  * 변경 내역이 조회 모델에 실시간으로 반영되어야 한다면 동기 이벤트와 글로벌 트랜잭션을 통해 실시간으로 동기화 할 수 있다. 하지만 그에 따른 성능을 트레이드 오프로 감수해야 한다.

### CQRS의 장단점
* 장점
  * 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다.
  * 조회 성능을 향상시키는 데 유리하다.
* 단점
  * 구현해야할 코드가 더 많아진다.
  * 더 많은 구현 기술을 필요로 한다.
* CQRS 패턴을 도입할지는 여러 장단점들을 고려해서 그 타당성에 대해 충분히 검토해야 한다.
